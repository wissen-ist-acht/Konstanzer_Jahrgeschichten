<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transcriptions - Konstanzer Jahrgeschichten</title>

  <!-- Bootstrap core CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

  <!-- Own CSS -->
  <link rel="stylesheet" type="text/css" href="css/jahrgeschichten.css" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">


  <style>
    body {
      padding-top: 5rem;
    }
    /* Styles for the transcription view */
    tei-p, tei-ab {
      margin-bottom: 1rem;
      display: block;
    }
    /* Base styles for transcription text */
    .transcription-entry tei-text {
      /* font-family: Helvetica, Arial, sans-serif; */
      font-family: 'Source Sans Pro', sans-serif;
      font-size: 1rem;
      line-height: 1.2;
    }
    /* Style for the displayed 'n' attribute */
    tei-ab::before {
      content: attr(n) ". ";
      color: #6c757d; /* Muted grey for the year, no bold */
      margin-right: 0.5em;
      /* Optional: style the number differently if needed */
    }
    .transcription-body {
      display: none;
      padding-top: 1.5rem;
      border-top: 1px solid #e0e0e0;
  
    }
    /* Style for other abbreviation marks (like apostrophes) */
    .abbreviation-mark {
      font-style: italic;
      color: #0066cc;
    }
    /* Special styling for the "9" abbreviation mark */
    .abbreviation-mark:has-text("9") {
      font-weight: bold;
  }
    /* Hide the 'n' attribute if it's not present or if you want to control its display more precisely */
    tei-ab:not([n])::before {
      content: none;
    }
    .unclear {
      background-color: #f0f0f0;
      border-bottom: 1px dotted #999;
      cursor: help;
    }
    .transcription-entry hr {
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    .ms-identifier-header {
    padding-bottom: 1rem;
    cursor: pointer;
      position: relative;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .ms-identifier-header::after {
      content: '▼';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      color: #6c757d;
    }
    .ms-identifier-header.active::after {
      content: '▲';
    }
    .transcription-entry:first-of-type {
      margin-top: 3rem;
    }

    /* Overlined letter styling */
    .overlined-letter {
    text-decoration: overline;
    text-decoration-thickness: 1px;
    text-decoration-color: currentColor; /* This makes the overline match the text color */
}

    /* Abbreviation tooltip styling */
    .tei-abbreviation {
      /* display: inline-block; */
      cursor: help;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
    }

    /* Color only the overlined letter */
.overlined-letter {
    color: #0066cc; 
}

  /* Color only the abbreviation mark  */
  .abbreviation-mark {
    color: #0066cc; 
    font-style: italic;
  }

    .tei-abbreviation:hover {
      color: #004499;
    }

  /* Styling for later additions */
  ins {
  color: #006633; /* A dark green color */
  font-style: italic;
  background-color: #f0f8f0; /* A very light green background */
  padding: 0 2px;
  border-radius: 3px;
  cursor: help; /* Show a help cursor to indicate a tooltip is available */
  text-decoration: none; /* Remove the default underline for <ins> tags */
}



  </style>

  <!-- CETEIcean script -->

 <!-- CETEIcean script -->
<script src="js/CETEI.js"></script>
<script>
let c = new CETEI();
let behaviors = {
  "tei": {
    "head": function(e) {
      let level = document.evaluate("count(ancestor::tei-div)", e, null, XPathResult.NUMBER_TYPE, null);
      let result = document.createElement("h" + level.numberValue);
      for (let n of Array.from(e.childNodes)) {
        result.appendChild(n.cloneNode());
      }
      return result;
    },
    "teiHeader": function(e) {
      return;
    },
    "lb": ["<br>"],
"choice": function(e) {
  const abbr = e.querySelector("tei-abbr");
  const expan = e.querySelector("tei-expan");
  
  const result = document.createElement("abbr");
  result.classList.add("tei-abbreviation");
  
  if (abbr) {
    // Process the abbreviation by walking through its child nodes
    let currentNode = abbr.firstChild;
    
    while (currentNode) {
      if (currentNode.nodeType === Node.TEXT_NODE) {
        // Handle text nodes
        result.appendChild(document.createTextNode(currentNode.textContent));
        
      } else if (currentNode.tagName === 'TEI-AM') {
        // Handle abbreviation marks
        const amContent = currentNode.textContent.trim();
        
        if (amContent === '¯' || amContent === '-') {
          // For macrons/overlines: apply overline to the previous character
          const lastChild = result.lastChild;
          if (lastChild && lastChild.nodeType === Node.TEXT_NODE && lastChild.textContent.length > 0) {
            const text = lastChild.textContent;
            const lastChar = text.slice(-1);
            const restOfText = text.slice(0, -1);
            
            // Replace the text node
            lastChild.textContent = restOfText;
            
            // Add the last character with overline
            const span = document.createElement("span");
            span.className = "overlined-letter";
            span.textContent = lastChar;
            result.appendChild(span);
          }
        } else {
          // For other abbreviation marks (like apostrophe, etc.): display them as is
          const span = document.createElement("span");
          span.className = "abbreviation-mark";
          span.textContent = amContent;
          result.appendChild(span);
        }
        
      } else {
        // Handle other elements
        result.appendChild(currentNode.cloneNode(true));
      }
      
      currentNode = currentNode.nextSibling;
    }
  }
  
  if (expan) {
    result.setAttribute("title", expan.textContent.trim());
  }
  
  return result;
},
    "am": function(e) {
      return document.createTextNode('');
    },
    "hi": function(e) {
      if (e.getAttribute("rend") === "sup") {
        const content = e.textContent.trim();
        if (content === 'o') {
          return document.createTextNode('\u0366');
        }
        const sup = document.createElement("sup");
        for (let node of e.childNodes) {
          sup.appendChild(node.cloneNode(true));
        }
        return sup;
      }
      const span = document.createElement("span");
      for (let node of e.childNodes) {
        span.appendChild(node.cloneNode(true));
      }
      return span;
    },
    "pb": function(e) {
      const folio = e.getAttribute("n");
      const fragment = document.createDocumentFragment();
      fragment.appendChild(document.createElement("br"));
      const marker = document.createElement("span");
      marker.className = "pb-marker";
      
      // Check if there's a following <cb> element for column information
      let nextSibling = e.nextElementSibling;
      let columnInfo = '';
      
      // Look for the next <cb> element
      while (nextSibling) {
        if (nextSibling.tagName === 'TEI-CB') {
          const column = nextSibling.getAttribute("n");
          if (column) {
            columnInfo = column;
          }
          break;
        }
        nextSibling = nextSibling.nextElementSibling;
      }
      
      // Display folio and column information
      if (columnInfo) {
        marker.textContent = `[f. ${folio}${columnInfo}] `;
      } else {
        marker.textContent = `[f. ${folio}] `;
      }
      
      fragment.appendChild(marker);
      return fragment;
    },
    "cb": function(e) {
      // Return empty since we handle column info in the pb behavior
      return document.createTextNode('');
    },
    "hyphen": function(e) {
      return e.nextElementSibling && e.nextElementSibling.tagName === 'BR' ? '' : '-';
    },
    "add": function(e) {
  // Create an <ins> element, which is semantically correct for an insertion.
  const insElement = document.createElement("ins");

  // --- Build the tooltip text from the TEI attributes ---
  let tooltipText = "Addition";
  const placeAttr = e.getAttribute('place');
  const handAttr = e.getAttribute('hand');

  if (placeAttr) {
    const place = placeAttr.replace('_', ' '); // Make 'margin_right' -> 'margin right'
    tooltipText += ` in the ${place}`;
  }
  if (handAttr) {
    const handId = handAttr.substring(1); // remove the '#'
    // Find the hand's description in the <teiHeader> for a better tooltip
    const handNote = document.querySelector(`tei-handnote[xml\\:id='${handId}'] p`);
    if (handNote) {
      tooltipText += ` (by: ${handNote.textContent.trim()})`;
    } else {
      tooltipText += ` (by hand: ${handId})`; // Fallback if not found
    }
  }
  
  insElement.setAttribute("title", tooltipText);

  // Move all the processed children (the actual text) from the original
  // <tei-add> element into our new <ins> element.
  while (e.firstChild) {
    insElement.appendChild(e.firstChild);
  }

  return insElement;
},
  }
};

document.addEventListener('DOMContentLoaded', function() {
  const unclearElements = document.querySelectorAll('tei-unclear');
  console.log("Found", unclearElements.length, "tei-unclear elements");
  
  unclearElements.forEach(function(el) {
    // Apply tooltip directly to the tei-unclear element
    el.classList.add('unclear');
    el.title = 'unclear: ' + el.getAttribute('reason');
  });
});

c.addBehaviors(behaviors);

// Wait for the DOM to be fully loaded before running the script
window.addEventListener('DOMContentLoaded', (event) => {
  const main = document.querySelector("main");

  // Check if a specific manuscript is requested via URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const requestedMs = urlParams.get('ms');
  
  // Mapping of URL parameters to file paths
  const msFiles = {
    'Fre_Hs_471': 'manuscripts/Fre_Hs_471.xml',
    'Got_Chart_158': 'manuscripts/Got_Chart_158.xml',
    'Hei_Cod_Sal_IX_28': 'manuscripts/Hei_Cod_Sal_IX_28.xml',
    'Hei_cpg_475': 'manuscripts/Hei_cpg_475.xml',
    'Mue_Cgm_567': 'manuscripts/Mue_Cgm_567.xml',
    'Mue_Cgm_568': 'manuscripts/Mue_Cgm_568.xml',
    'StG_Cod_Sang_630': 'manuscripts/StG_Cod_Sang_630.xml'
  };

  // A reusable function to load and display a transcription
  function loadTranscription(fileUrl) {
    c.getHTML5(fileUrl, function(doc) {
      if (main) {
        const transcriptionContainer = document.createElement('div');
        transcriptionContainer.className = 'transcription-entry';
        const msId = doc.querySelector("tei-msidentifier");
        const teiText = doc.querySelector("tei-text");

        if (msId && teiText) {
          const msIdContainer = document.createElement('div');
          msIdContainer.className = 'ms-identifier-header';
          msIdContainer.appendChild(msId);
          transcriptionContainer.appendChild(msIdContainer);
          
          teiText.classList.add('transcription-body');
          
          // Show by default if single manuscript, hide if multiple
          if (requestedMs) {
            teiText.style.display = "block";
            msIdContainer.classList.add('active');
          } else {
            teiText.style.display = "none";
          }
          
          transcriptionContainer.appendChild(teiText);

          // Add click event to toggle visibility
          msIdContainer.addEventListener('click', function() {
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if (content.style.display === "block") {
              content.style.display = "none";
            } else {
              content.style.display = "block";
            }
          });
        } else {
          if (msId) transcriptionContainer.appendChild(msId);
          if (teiText) transcriptionContainer.appendChild(teiText);
        }

        transcriptionContainer.appendChild(document.createElement('hr'));
        main.appendChild(transcriptionContainer);
      }
    });
  }

  // Load transcriptions based on URL parameter
  if (requestedMs && msFiles[requestedMs]) {
    // Load single transcription
    loadTranscription(msFiles[requestedMs]);
  } else {
    // Load all transcriptions
    loadTranscription('manuscripts/Fre_Hs_471.xml');
    loadTranscription('manuscripts/Got_Chart_158.xml');
    loadTranscription('manuscripts/Hei_Cod_Sal_IX_28.xml');
    loadTranscription('manuscripts/Hei_cpg_475.xml');
    loadTranscription('manuscripts/Mue_Cgm_567.xml');
    loadTranscription('manuscripts/Mue_Cgm_568.xml');
    loadTranscription('manuscripts/StG_Cod_Sang_630.xml');
  }
});
</script> 
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
          <a class="navbar-brand" href="index.html">Konstanzer Jahrgeschichten</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExampleDefault" aria-controls="navbarsExampledefault" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
              <li class="nav-item">
              <a class="nav-link" href="manuscripts.html">Manuscripts</a>
            </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle active" aria-current="page"href="#" id="transcriptionsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Transcriptions
                </a>
                <ul class="dropdown-menu" aria-labelledby="transcriptionsDropdown">
                  <li><a class="dropdown-item" href="transcriptions.html">All Transcriptions</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Fre_Hs_471">Freiburg, Hs. 471</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Got_Chart_158">Gotha, Chart. A 158</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Hei_Cod_Sal_IX_28">Heidelberg, Cod. Sal. IX, 28</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Hei_cpg_475">Heidelberg, Cpg 475</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Mue_Cgm_567">München, Cgm 567</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=Mue_Cgm_568">München, Cgm 568</a></li>
                  <li><a class="dropdown-item" href="transcriptions.html?ms=StG_Cod_Sang_630">St. Gallen, Cod. Sang. 630</a></li>
                </ul>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="https://www.zotero.org/groups/6133894/konstanzer_jahrgeschichten/library" target="_blank">Literature</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="about.html">About</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    
      <main class="container">
        <h1>Transcriptions of the Konstanzer Jahrgeschichten</h1>
        <h2>(work in progress)</h2>
        <!-- Transcriptions will be loaded here by the script -->
      </main>
    
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>    
</body>
</html>